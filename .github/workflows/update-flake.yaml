name: Update flake inputs
run-name: Update flake inputs by ${{ github.actor }}
on:
  schedule:
    - cron: '0 0 */3 * *' # Every 3 days at midnight UTC
  workflow_dispatch:
jobs:
  update:
    name: Update flake inputs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Set up Nix
        uses: cachix/install-nix-action@v31
      - name: Update flake inputs
        id: update
        run: |
          nix flake update --accept-flake-config 2>&1 | tee update-output.txt
          {
            echo "output<<EOF"
            cat update-output.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Generate update summary
        id: summary
        run: |
          # Check if there are changes
          if git diff --exit-code flake.lock > /dev/null 2>&1; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_changes=true" >> "$GITHUB_OUTPUT"

          # Build summary with table
          {
            echo "## Flake Input Updates"
            echo ""
            echo "| Input | Diff |"
            echo "|-------|------|"
          } > summary.md

          # Parse flake.lock for changes
          python3 <<'PYTHON' >> summary.md
          import json
          import subprocess

          # Get old lock
          old_lock = json.loads(subprocess.check_output(['git', 'show', 'HEAD:flake.lock']))
          # Get new lock
          with open('flake.lock') as f:
              new_lock = json.load(f)

          for node_name, node_data in new_lock['nodes'].items():
              if node_name == 'root':
                  continue

              old_node = old_lock['nodes'].get(node_name, {})
              old_locked = old_node.get('locked', {})
              new_locked = node_data.get('locked', {})

              old_rev = old_locked.get('rev')
              new_rev = new_locked.get('rev')

              if old_rev and new_rev and old_rev != new_rev:
                  owner = new_locked.get('owner')
                  repo = new_locked.get('repo')

                  if owner and repo:
                      link = f"https://github.com/{owner}/{repo}/compare/{old_rev}...{new_rev}"
                      print(f"| `{node_name}` | [`{old_rev[:7]}...{new_rev[:7]}`]({link}) |")
          PYTHON

          cat summary.md >> "$GITHUB_STEP_SUMMARY"

          {
            echo "body<<EOF"
            cat summary.md
            echo ""
            echo '```'
            cat update-output.txt
            echo '```'
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Create pull request
        if: steps.summary.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: |
            chore: update flake inputs

            ${{ steps.update.outputs.output }}
          title: "chore: update flake inputs"
          body: ${{ steps.summary.outputs.body }}
          branch: update-flake-inputs
          delete-branch: true
          labels: dependencies
